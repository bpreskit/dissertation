In our model for the ptychographic setup of \eqref{eq:ptych_meas}, we assume that measurements are taken corresponding to all shifts $\ell \in [d]_0$.  Unfortunately, in practice, this is usually an impossibility, since in many cases an illumination of the sample can cause damage to the sample \cite{starodub2008damage}, and applying the illumination beam (which can be highly irradiative) repeatedly at a single point can destroy it.  In ptychography as it is usually performed in the lab, the beam is shifted by a far larger distance than the width of a single pixel -- instead of overlapping on $\delta - 1$ of $\delta$ pixels, adjacent illumination regions will typically overlap on a percentage of their support on the order of $50\%$ or even less \cite{marchesini2015coptych,shapiro2014nanometer}.  Considering the risks to the sample and the costs of operating the measurement equipment, there are strong incentives to reduce the number of illuminations applied to any object, and therefore our theory ought to address a model that reflects this concern.

Towards this model, instead of using all shifts in our lifted measurement system, we instead fix a shift size $s \in \N$ where $d = \dbar s$ with $\dbar \in \N$ and use $S^{s \ell} m_j m_j^* S^{-s \ell}$ for $\ell \in [\dbar]$.  In this light, we introduce the following generalization of the lifted measurement system: given a family of masks of support $\delta$, $\{m_j\}_{j \in [D]} \subset \C^d$, and $s, \dbar \in \N$ with $\dbar = d / s$, the associated \emph{lifted measurement system of shift $s$} is the set \begin{equation} \Lc_{\{m_j\}}^s := \{S^{s \ell} m_j m_j^* S^{-s \ell}\}_{(\ell, j) \in [\dbar]_0 \times [D]} \subset \C^{d \times d}. \label{eq:lift_pty_sys}\end{equation}

This leads to an obvious redefinition of the measurement operator, now $\Ac : \Cdxd \to \R^{[\dbar]_0 \times [D]}$: \begin{equation} \mathcal{A}(X)_{(\ell, j)} = \inner{S^{s \ell} m_j m_j^* S^{-s \ell}, X}, \quad (\ell, j) \in [\dbar]_0 \times [D]. \label{eq:pty_meas_op} \end{equation}  This will also force us to reconsider the subspace of $\Cdxd$ with which we are working in the domain of $\Ac$, since it is clearly impossible, by inspection of \cref{fig:T_delta_s}, for $\Lc^s$ to span $T_\delta(\Cdxd)$ with a shift size $s > 1$.  In an effort to define the subspace analogous to $T_\delta(\Cdxd)$ in the ptychographic case, we let $\Jc_{\delta, s} = \bigcup_{\ell \in [\dbar]_0}\supp(S^{s \ell} \one \one^* S^{-s \ell})$ be the set of indices ``reached'' by this system, and we let \begin{equation} T_{\delta, s}(X) = \left\{\begin{array}{r@{,\quad}l} X_{ij} & (i, j) \in \Jc_{\delta, s} \\ 0 & \text{otherwise}\end{array}\right.\label{eq:T_delta_s}\end{equation} be the projection onto the associated subspace of $\Cdxd$.  $T_{\delta, s}$ is visualized in \cref{fig:T_delta_s}.
\begin{figure}
  \centering
  \begin{subfigure}[b]{0.4\textwidth}    
    \begin{tikzpicture}[ampersand replacement=\&,baseline=-\the\dimexpr\fontdimen22\textfont2\relax]
    \matrix (m)[matrix of math nodes,left delimiter=(,right delimiter=)]
            {
              * \& * \& * \&   \&   \&   \& * \& * \\
              * \& * \& * \& * \&   \&   \&   \& * \\
              * \& * \& * \& * \& * \&   \&   \&   \\
                \& * \& * \& * \& * \& * \&   \&   \\
                \&   \& * \& * \& * \& * \& * \&   \\
                \&   \&   \& * \& * \& * \& * \& * \\
              * \&   \&   \&   \& * \& * \& * \& * \\
              * \& * \&   \&   \&   \& * \& * \& * \\
            };

            \begin{pgfonlayer}{myback}
              \fhighlight[blue!30]{m-1-1}{m-3-3}
              \fhighlight[blue!30]{m-2-2}{m-4-4}
              \fhighlight[blue!30]{m-3-3}{m-5-5}
              \fhighlight[blue!30]{m-4-4}{m-6-6}
              \fhighlight[blue!30]{m-5-5}{m-7-7}
              \fhighlight[blue!30]{m-6-6}{m-8-8}
              \fhighlight[blue!30]{m-7-1}{m-8-1}
              \fhighlight[blue!30]{m-1-7}{m-1-8}
              \fhighlight[blue!30]{m-8-8}{m-8-8}
              \fhighlight[blue!30]{m-8-1}{m-8-2}
              \fhighlight[blue!30]{m-1-8}{m-2-8}
              \fhighlight[blue!30]{m-1-1}{m-2-2}
            \end{pgfonlayer}
  \end{tikzpicture}
    \caption{$T_3(\C^{8 \times 8})$}
  \end{subfigure}
  \begin{subfigure}[b]{0.4\textwidth}
    \begin{tikzpicture}[ampersand replacement=\&,baseline=-\the\dimexpr\fontdimen22\textfont2\relax]
    \matrix (m)[matrix of math nodes,left delimiter=(,right delimiter=)]
            {
              * \& * \& * \&   \&   \&   \& * \& * \\
              * \& * \& * \& * \&   \&   \&   \& * \\
              * \& * \& * \& * \& * \&   \&   \&   \\
                \& * \& * \& * \& * \& * \&   \&   \\
                \&   \& * \& * \& * \& * \& * \&   \\
                \&   \&   \& * \& * \& * \& * \& * \\
              * \&   \&   \&   \& * \& * \& * \& * \\
              * \& * \&   \&   \&   \& * \& * \& * \\
            };

            \begin{pgfonlayer}{myback}
              \fhighlight[blue!30]{m-1-1}{m-3-3}
              %\fhighlight[blue!30]{m-2-2}{m-4-4}
              \fhighlight[blue!30]{m-3-3}{m-5-5}
              %\fhighlight[blue!30]{m-4-4}{m-6-6}
              \fhighlight[blue!30]{m-5-5}{m-7-7}
              %\fhighlight[blue!30]{m-6-6}{m-8-8}
              \fhighlight[blue!30]{m-7-1}{m-8-1}
              \fhighlight[blue!30]{m-1-7}{m-1-8}
              \fhighlight[blue!30]{m-7-7}{m-8-8}
              %\fhighlight[blue!30]{m-8-8}{m-8-8}
              %\fhighlight[blue!30]{m-8-1}{m-8-2}
              %\fhighlight[blue!30]{m-1-8}{m-2-8}
              %\fhighlight[blue!30]{m-1-1}{m-2-2}
            \end{pgfonlayer}
    \end{tikzpicture}
    \caption{$T_{3, 2}(\C^{8 \times 8})$}
  \end{subfigure}
  \caption{$T_\delta(\C^{d \times d})$ vs. $T_{\delta, s}(\C^{d \times d})$ for $d = 8, \delta = 3, s = 2$}
  \label{fig:T_delta_s}  
\end{figure}
To get a feel for $\Jc_{\delta, s}$, we observe that \[\left(S^{s \ell} m_k m_k^* S^{-s \ell}\right)_{ij} = (S^{s \ell} m_k)_i (\overline{S^{s \ell} m_k})_j = (m_k)_{i - s \ell} (\overline{m_k})_{j - s\ell},\] so $\left(S^{s \ell} m_k m_k^* S^{-s \ell}\right)_{ij} = 0$ when $(i - s \ell, j - s \ell) \notin [\delta]^2$, i.e.~when $(i, j) \notin [\delta]^2_{s \ell + 1}$.  Hence the indices onto which we are projecting are those in $\Jc_{\delta, s} = \bigcup_{\ell \in [\dbar]_0} [\delta]_{s \ell + 1}^2$.  This set may be revisualized by calculating which $j$'s are admissible for each $i$; for a fixed $i$, we look at all shifts $\ell$ such that $i \in [\delta]_{s\ell + 1}$, and $j$ is allowed to be in their union.  

In the (pathological) case where $s \ge \delta$, obviously any given index can only appear in one of the $[\delta]_{s \ell + 1}$, namely $i \in [\delta]_{s \ell + 1}$ iff $i \mod s \le \delta$ and $\floor{i / s} = \ell$, so in this case we would have \[\Jc_{\delta, s} = \{(i, j) : \floor{i / s} = \floor{j / s} \ \text{and} \ i \mathbin{\mathrm{mod}} s, j \mod s \le \delta\}.\]  However, this case is not typical, since $T_{\delta, s}(\one \one^*)$ will be the adjacency matrix of an unconnected graph, and there will be groups of coordinates whose relative phases are completely undetermined by $T_{\delta, s}(x x^*)$, which makes such an arrangement unfeasible from a phase retrieval point of view.  For example, for any $\theta \in \R$, we have \[T_{2, 2}\left(\begin{bmatrix} 1 \\ 1 \\ 1 \\ 1 \end{bmatrix} \begin{bmatrix} 1 \\ 1 \\ 1 \\ 1 \end{bmatrix}^*\right) = T_{2, 2}\left(\begin{bmatrix} 1 \\ 1 \\ \eit \\ \eit \end{bmatrix} \begin{bmatrix} 1 \\ 1 \\ \eit \\ \eit \end{bmatrix}^*\right) = \begin{bmatrix} 1 & 1 & 0 & 0 \\ 1 & 1 & 0 & 0 \\ 0 & 0 & 1 & 1 \\ 0 & 0 & 1 & 1 \end{bmatrix} \] %any of the phase synchronization techniques of \cref{ch:ang_sync} will fail, as the graph Laplacian \eqref{eq:graph_laplacian_normd} will have a spectral gap of zero.

%%   In the ordinary case, where $s < \delta$, it is clear that we need only consider the first and last shifts that cover $i$, namely $i \in [\delta]_{1 + s \ell}$ iff $\ceil{\frac{i - \delta}{s}} \le \ell \le \ceil{\frac{i - s}{s}}$, and therefore
%% \begin{align*}
%%   \Jc_{\delta, s} = &\left\{(i, j) : j \in \left\{\ceil*{\frac{i - \delta}{s}}s + 1, \cdots, \ceil*{\frac{i - \delta}{s}} + \delta\right\}\right. \\
%%    &\bigcup\, \left.\left\{\ceil*{\frac{i - s}{s}}s + 1, \cdots, \ceil*{\frac{i - s}{s}}s + \delta \right\} \right\}\\
%%   = &\left\{(i, j) : j = \ceil*{\frac{i - \delta}{s}}s + 1, \ldots, \ceil*{\frac{i - s}{s}}s + \delta \right\}
%% \end{align*}
%% Unfortunately, this formulation is not particularly transparent, but we mention an important special case.  When $s$ is also a divisor of $\delta$, say $\delta = \deltabar s$, then this condition becomes
%% \begin{gather*}
%%   (i, j) \in \Jc_{\delta, s} \iff \left(\ceil*{\frac{i}{s}} - \deltabar\right) s + 1 \le j \le \left(\ceil*{\frac{i}{s}} - 1\right) s + \delta \\
%%   \iff \frac{1}{s} - \deltabar \le  \frac{j}{s} - \ceil*{\frac{i}{s}} \le \deltabar - 1 \\
%% %  \iff 1 - \deltabar \le \ceil*{\frac{j}{s}} - \ceil*{\frac{i}{s}} \le \deltabar - 1 \\
%%   \iff \left| \ceil*{\frac{j}{s}} - \ceil*{\frac{i}{s}} \right| < \deltabar.
%% \end{gather*}

Before addressing invertibility and conditioning of lifted measurement systems with shifts, for $N \in \N$, we introduce $\Tc_N : \bigcup_{\ell \in \N} \C^{\ell N \times m} \to \bigcup_{\ell \in \N} \C^{\ell m \times N},$ the blockwise transpose operator, defined by \[\Tc_N\left(\begin{bmatrix} V_1 \\ \vdots \\ V_\ell \end{bmatrix}\right) = \begin{bmatrix} V_1^* \\ \vdots \\ V_{\ell}^* \end{bmatrix}\] for $V_1, \ldots, V_\ell \in \C^{N \times m}$.

We also define, for $(k_j)_{j = 1}^n$ and permutation $P \in \{0, 1\}^{n \times n}$, the \emph{blockwise permutation operator} $\Pc(P, (k_j)) : \C^{K \times K} \to \C^{K \times K}$, where $K = \sum_{j = 1}^n k_j$.  Our intention will be to permute the blocks of a block vector $\rowmat{v^T}{1}{n}^T$, where $v_j \in \C^{k_j}$.  In order to specify $\Pc(P, (k_j))$ precisely, we introduce an overloading of notation on permutations: namely, if $P \in \{0, 1\}^{m \times m}$ is a permutation, then we identify $P$ with the mapping $\pi : [m] \to [m]$ where $\pi(i) = j$ whenever $P e_i = e_j$.  In particular, if we write $P(i)$, we mean ``$j$ such that $P e_i = e_j$.''  With this in mind, $\Pc(P, (k_j))$ is defined, for $v_j \in \C^{k_j}$, by \begin{equation} \Pc(P, (k_j)) \colmatfl{v_1}{v_n} = \colmatfl{v_{P(1)}}{v_{P(n)}}. \label{eq:block_perm} \end{equation}  Another way of stating $\Pc(P, (k_j))$ is that it takes $P$ and replaces its $j\th$ (from left to right) $1$ with $I_{k_j}$, resizing as necessary.  For example, if \[P = \begin{bmatrix} 0 & 0 & 1 \\ 0 & 1 & 0 \\ 1 & 0 & 0 \end{bmatrix},\] then
\[
  \Pc(P, (1, 2, 3)) = \begin{bmatrix} 0 & 0 & I_3 \\ 0 & I_2 & 0 \\ I_1 & 0 & 0 \end{bmatrix} = \left[\begin{array}{c|cc|ccc}
    0 & 0 & 0 & 1 & 0 & 0 \\
    0 & 0 & 0 & 0 & 1 & 0 \\
    0 & 0 & 0 & 0 & 0 & 1 \\ \hline
    0 & 1 & 0 & 0 & 0 & 0 \\
    0 & 0 & 1 & 0 & 0 & 0 \\ \hline
    1 & 0 & 0 & 0 & 0 & 0 \\
  \end{array}\right]
\]
Defined by blocks, we have $\Pc(P, (1, 2, 3)) \begin{bmatrix} v_1^T & v_2^T & v_3^T \end{bmatrix}^T = \begin{bmatrix} v_3^T & v_2^T & v_1^T \end{bmatrix}$, or, for example, \[\Pc(P, (1, 2, 3)) \left[\begin{array}{c} 1 \\ \hline 2 \\ 3 \\ \hline 4 \\ 5 \\ 6 \end{array}\right] = \left[\begin{array}{c} 4 \\ 5 \\ 6 \\ \hline 2 \\ 3 \\ \hline 1 \end{array}\right].\]
